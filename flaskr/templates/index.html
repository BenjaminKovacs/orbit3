<!--<span id='test'></span>
<br></br>
yay, it works!-->
<canvas id='canvas'></canvas>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">
//socket.io setup code from https://flask-socketio.readthedocs.io/en/latest/
    var socket = io.connect('http://' + document.domain + ':' + location.port);
    var circles = [];
    var rectangles = [];
    var polygons = [];
    var thingsToDraw = [];
    var scale;
    var view = {x:0,
                y:0}

    //record keys currently pressed, copied from capture the flag game I created
    keysPressed = [];
    for (i=0; i < 193; i++){keysPressed[i]=false;}

    function resetPressedKeys(){
    for (i=0; i < 193; i++){keysPressed[i]=false;}
    }


    window.addEventListener('keydown', function (e) {
    for (i = 8; i < 193; i++){
        if (e.keyCode == i){
        keysPressed[i] = true;
        }
    }
    if (e.keyCode == 37 || e.keyCode==65){
            socket.emit('rotate',1);
        }
    if (e.keyCode == 39 || e.keyCode==68){
            socket.emit('rotate',-1);
        }
    if (e.keyCode == 38 || e.keyCode==87){
            socket.emit('fire engine',1);
        }
    if (e.keyCode == 40 || e.keyCode==83){
        console.log('shooting');
        socket.emit('shoot');
        }
    });
    window.addEventListener('keyup', function (e) {
    for (i = 8; i < 193; i++){
        if (e.keyCode == i){
        keysPressed[i] = false;
        }
    }
    if (e.keyCode == 37 || e.keyCode==65){
            socket.emit('rotate',0);
        }
    if (e.keyCode == 39 || e.keyCode==68){
            socket.emit('rotate',0);
        }
    if (e.keyCode == 38 || e.keyCode==87){
            socket.emit('fire engine',0);
        }
    });

    //left = keysPressed[37] || keysPressed[65];
    //right = keysPressed[39] || keysPressed[68];
    //up = keysPressed[38] || keysPressed[87];
    //down = keysPressed[40] || keysPressed[83];

    socket.on('connect', function() {
        socket.emit('my event', {data: 'I\'m connected!'});
        var canvas = document.getElementById('canvas');
        var margin = 16; //remove scroll bars
        var width = window.innerWidth-margin;
        var height = window.innerHeight-margin;
        var whRatio = 1536/754;
        if (width/height > whRatio){
            canvas.height = height;
            canvas.width = whRatio * height;
        }
        else{
            canvas.width = width;
            canvas.height = width/whRatio;
        }
        console.log('width'+canvas.width+' height'+canvas.height);
        scale = canvas.width/1536;
        context = canvas.getContext('2d');
        context.fillStyle = 'black';
        context.fillRect(0,0,canvas.width,canvas.height);
        tick();
    });
    socket.on('test',function(message){
        //document.getElementById('test').innerHTML = message;
    });

    socket.on('update', function(data){
        console.log(data);
        thingsToDraw = JSON.parse(JSON.stringify(data));
        circles = thingsToDraw.circles;
        rectangles = thingsToDraw.rectangles;
        polygons = thingsToDraw.polygons;
    });
    var adjust;
    socket.on('view', function(data){
        view = JSON.parse(JSON.stringify(data));
        adjust = 1/(2*Math.sqrt(Math.pow((circles[0].x - view.x),2)+Math.pow((circles[0].y - view.y),2)))
    });

    window.addEventListener('mousedown', function (e) {
        console.log('x: '+e.clientX, 'y: '+e.clientY);
        console.log(window.innerWidth)
    })

    function drawCircles(){
        
        var count = 0;
        while (count<circles.length){
            context.beginPath();
            var x = ((circles[count].x-view.x)+canvas.width/2) * scale;
            var y = ((circles[count].y-view.y)+canvas.height/2) * scale;
            var r = circles[count].r * scale;
            var color = circles[count].color;
            context.fillStyle = color;
            context.ellipse(x, y, r, r, 0, 2 * Math.PI, false);
            console.log('x'+x+'y'+y+'r'+r);
            context.fill();
            count++;
            context.closePath();
        }
        
    }

    function drawRectangles(){}
    //https://www.w3schools.com/tags/canvas_lineto.asp
    //http://scienceprimer.com/drawing-regular-polygons-javascript-canvas
    function drawPolygons(){
        var count = 0;
        while (count < polygons.length){
            polygon = polygons[count];
            //console.log(polygon.points[0].x);
            context.fillStyle = polygon.color;
            context.beginPath();
            context.moveTo((polygon.points[0].x-view.x+canvas.width/2)*scale, 
                    (polygon.points[0].y-view.y+canvas.height/2)*scale);
            var pointNum = 1;
            while(pointNum < polygon.points.length){
                context.lineTo((polygon.points[pointNum].x-view.x+canvas.width/2)*scale,
                        (polygon.points[pointNum].y-view.y+canvas.height/2)*scale);
                pointNum++;
            }
            context.fill();
            context.stroke();
            context.closePath();
            
            count++;
        }
    }

    function tick(){
        context.fillStyle = 'black';
        context.fillRect(0,0,canvas.width,canvas.height);
        drawCircles();
        drawRectangles();
        drawPolygons();
        //socket.emit('my event', {data: 'I\'m connected!'});
        window.requestAnimationFrame(tick);
    }
</script>

